generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(uuid())
  email            String?  @unique
  username         String?  @unique
  passwordHash     String?  @map("password_hash")
  displayName      String   @map("display_name")
  phoneNumber      String?  @map("phone_number")
  paymentMethod    String?  @map("payment_method")
  profilePictureUrl String? @map("profile_picture_url") @db.Text
  
  // Email verification
  emailVerified    Boolean  @default(false) @map("email_verified")
  emailVerifyToken String?  @map("email_verify_token")
  emailVerifyExpires DateTime? @map("email_verify_expires")
  
  // Password reset
  passwordResetToken String? @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")
  
  // Account security
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockUntil        DateTime? @map("lock_until")
  lastLoginAt      DateTime? @map("last_login_at")
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  
  palmTemplates      PalmTemplate[]
  enrollments        Enrollment[]
  devices            Device[]
  apiTokens          ApiToken[]
  authenticationLogs AuthenticationLog[]
  cards              Card[]
  orders             Order[]
  redemptions        Redemption[]
  refreshTokens      RefreshToken[]
  
  @@map("users")
}

// Refresh tokens for JWT rotation
model RefreshToken {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  tokenHash    String   @unique @map("token_hash")
  deviceInfo   String?  @map("device_info")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  revokedAt    DateTime? @map("revoked_at")
  replacedBy   String?  @map("replaced_by")
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model PalmTemplate {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  sdkVendor      String   @default("veinshine") @map("sdk_vendor")
  featureVersion String   @default("1.0") @map("feature_version")
  
  leftRgbFeature  String?  @map("left_rgb_feature") @db.Text
  leftIrFeature   String?  @map("left_ir_feature") @db.Text
  rightRgbFeature String?  @map("right_rgb_feature") @db.Text
  rightIrFeature  String?  @map("right_ir_feature") @db.Text
  
  active         Boolean  @default(true)
  enrolledAt     DateTime @default(now()) @map("enrolled_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("palm_templates")
}

model Device {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  platform    String
  publicKey   String?  @map("public_key") @db.Text
  lastSeenAt  DateTime @default(now()) @map("last_seen_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  
  @@index([userId])
  @@map("devices")
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  deviceId  String   @map("device_id")
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([deviceId])
  @@map("enrollments")
}

model ApiToken {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  tokenHash  String   @unique @map("token_hash")
  scope      String   @default("palm:verify")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@map("api_tokens")
}

model AuthenticationLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  deviceType   String   @map("device_type")
  location     String?
  success      Boolean  @default(true)
  authenticatedAt DateTime @default(now()) @map("authenticated_at")
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([authenticatedAt])
  @@map("authentication_logs")
}

model Card {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  type           String
  name           String
  cardNumber     String   @map("card_number")
  color          String   @default("#0066CC")
  expiryDate     DateTime? @map("expiry_date")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  redemptions    Redemption[]
  
  @@index([userId])
  @@map("cards")
}

// NEW MODELS FOR STORE SYSTEM

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  imageUrl    String?  @map("image_url") @db.Text
  stock       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  orderItems  OrderItem[]
  
  @@map("products")
}

model Order {
  id            String   @id @default(uuid())
  customerId    String?  @map("customer_id")
  customerName  String?  @map("customer_name")
  status        String   @default("pending") // pending, completed, cancelled
  totalAmount   Decimal  @db.Decimal(10, 2) @map("total_amount")
  palmDeviceId  String?  @map("palm_device_id")
  createdAt     DateTime @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")
  
  customer      User?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  palmDevice    PalmDevice? @relation(fields: [palmDeviceId], references: [id], onDelete: SetNull)
  items         OrderItem[]
  
  @@index([customerId])
  @@index([status])
  @@index([palmDeviceId])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int     @default(1)
  price     Decimal @db.Decimal(10, 2)
  
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Campaign Redemptions - tracks when users redeem campaign cards via palm scan
model Redemption {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  userName        String?  @map("user_name")
  cardId          String?  @map("card_id")
  campaignName    String   @map("campaign_name")
  campaignVendor  String   @map("campaign_vendor")
  palmDeviceId    String?  @map("palm_device_id")
  location        String?
  status          String   @default("verified") // verified, failed
  redeemedAt      DateTime @default(now()) @map("redeemed_at")
  
  user           User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  card           Card?       @relation(fields: [cardId], references: [id], onDelete: SetNull)
  palmDevice     PalmDevice? @relation(fields: [palmDeviceId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([cardId])
  @@index([palmDeviceId])
  @@index([redeemedAt])
  @@map("redemptions")
}

model PalmDevice {
  id          String   @id @default(uuid())
  name        String
  apiToken    String   @unique @map("api_token")
  location    String?
  active      Boolean  @default(true)
  lastSeenAt  DateTime @default(now()) @map("last_seen_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  orders      Order[]
  redemptions Redemption[]
  deviceAuthLogs DeviceAuthenticationLog[]
  
  @@map("palm_devices")
}

model DeviceAuthenticationLog {
  id           String   @id @default(uuid())
  palmDeviceId String   @map("palm_device_id")
  deviceType   String   @map("device_type")
  location     String?
  success      Boolean  @default(false)
  reason       String?
  timestamp    DateTime @default(now())
  
  palmDevice   PalmDevice @relation(fields: [palmDeviceId], references: [id], onDelete: Cascade)
  
  @@index([palmDeviceId])
  @@index([timestamp])
  @@map("device_authentication_logs")
}

// Campaign Cards - wallet cards from BIOPIA Campaign Portal
model UserCard {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  campaignId      String   @map("campaign_id")
  cardName        String   @map("card_name")
  cardDescription String?  @map("card_description") @db.Text
  cardImageUrl    String?  @map("card_image_url") @db.Text
  backgroundColor String   @default("#1a1a2e") @map("background_color")
  textColor       String   @default("#ffffff") @map("text_color")
  discountType    String   @default("PERCENTAGE") @map("discount_type")
  discountValue   Int      @default(0) @map("discount_value")
  vendorName      String?  @map("vendor_name")
  vendorLogo      String?  @map("vendor_logo") @db.Text
  userCoverImageURL String? @map("user_cover_image_url") @db.Text
  active          Boolean  @default(true)
  addedAt         DateTime @default(now()) @map("added_at")
  lastUsedAt      DateTime? @map("last_used_at")
  
  @@unique([userId, campaignId])
  @@index([userId])
  @@index([campaignId])
  @@map("user_cards")
}

// ============================================
// DEVICE CONTENT MANAGEMENT (Ads/Announcements)
// ============================================

// Content Device Registration (for ads/media playback)
model ContentDevice {
  id              String    @id @default(uuid())
  deviceId        String    @unique @map("device_id")
  model           String?
  screenWidth     Int       @default(800) @map("screen_width")
  screenHeight    Int       @default(480) @map("screen_height")
  supportsVideo   Boolean   @default(true) @map("supports_video")
  lastSeen        DateTime  @default(now()) @map("last_seen")
  cachedContentIds String[] @default([]) @map("cached_content_ids")
  lastPlaybackReport DateTime? @map("last_playback_report")
  deviceGroupId   String?   @map("device_group_id")
  deviceGroup     ContentDeviceGroup? @relation(fields: [deviceGroupId], references: [id])
  createdAt       DateTime  @default(now()) @map("created_at")
  
  @@index([deviceId])
  @@index([deviceGroupId])
  @@map("content_devices")
}

// Device Groups (for bulk playlist assignment)
model ContentDeviceGroup {
  id          String    @id @default(uuid())
  name        String
  description String?
  devices     ContentDevice[]
  playlists   Playlist[]
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@map("content_device_groups")
}

// Content Items (images, videos, messages)
model ContentItem {
  id          String    @id @default(uuid())
  type        String    // 'image', 'video', 'message'
  title       String
  url         String    @db.Text
  posterUrl   String?   @map("poster_url") @db.Text
  durationSec Int       @default(10) @map("duration_sec")
  width       Int       @default(800)
  height      Int       @default(480)
  mimeType    String    @default("image/webp") @map("mime_type")
  sizeBytes   Int       @default(0) @map("size_bytes")
  checksum    String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  playlistItems PlaylistItem[]
  variants    ContentVariant[]
  playbackLogs PlaybackLog[]
  
  @@index([type])
  @@map("content_items")
}

// Content Variants (different resolutions/formats)
model ContentVariant {
  id          String    @id @default(uuid())
  contentId   String    @map("content_id")
  content     ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)
  url         String    @db.Text
  width       Int
  height      Int
  mimeType    String    @map("mime_type")
  sizeBytes   Int       @map("size_bytes")
  checksum    String?
  
  @@index([contentId])
  @@map("content_variants")
}

// Playlists (assigned to devices or device groups)
model Playlist {
  id            String    @id @default(uuid())
  name          String
  deviceId      String?   @map("device_id")
  deviceGroupId String?   @map("device_group_id")
  deviceGroup   ContentDeviceGroup? @relation(fields: [deviceGroupId], references: [id])
  version       Int       @default(1)
  active        Boolean   @default(true)
  items         PlaylistItem[]
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  @@index([deviceId])
  @@index([deviceGroupId])
  @@map("playlists")
}

// Playlist Items (content in a playlist with scheduling)
model PlaylistItem {
  id          String    @id @default(uuid())
  playlistId  String    @map("playlist_id")
  playlist    Playlist  @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  contentId   String    @map("content_id")
  content     ContentItem @relation(fields: [contentId], references: [id])
  priority    Int       @default(0)
  durationSec Int?      @map("duration_sec")
  startAt     DateTime? @map("start_at")
  endAt       DateTime? @map("end_at")
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@index([playlistId])
  @@index([contentId])
  @@map("playlist_items")
}

// Playback Logs (analytics)
model PlaybackLog {
  id             String    @id @default(uuid())
  deviceId       String    @map("device_id")
  contentId      String    @map("content_id")
  content        ContentItem @relation(fields: [contentId], references: [id])
  playedAt       DateTime  @default(now()) @map("played_at")
  durationPlayed Int       @default(0) @map("duration_played")
  completed      Boolean   @default(false)
  error          String?
  
  @@index([deviceId])
  @@index([contentId])
  @@index([playedAt])
  @@map("playback_logs")
}

// ============================================================
// BIOPIAT DISPLAY SYSTEM MODELS
// ============================================================

// Display Device (BIOPIAT devices with bottom-half display)
model DisplayDevice {
  id                     String    @id @default(uuid())
  deviceId               String    @unique @map("device_id")
  name                   String
  location               String?
  model                  String?
  screenWidth            Int?      @map("screen_width")
  screenHeight           Int?      @map("screen_height")
  appVersion             String?   @map("app_version")
  lastSeen               DateTime? @map("last_seen")
  lastSync               DateTime? @map("last_sync")
  currentPlaylistVersion Int?      @map("current_playlist_version")
  groupId                String?   @map("group_id")
  group                  DisplayDeviceGroup? @relation(fields: [groupId], references: [id])
  playlistId             String?   @map("playlist_id")
  playlist               DisplayPlaylist? @relation(fields: [playlistId], references: [id])
  logs                   DisplayDeviceLog[]
  urgentMessages         DisplayUrgentMessage[]
  createdAt              DateTime  @default(now()) @map("created_at")
  
  @@index([groupId])
  @@index([lastSeen])
  @@map("display_devices")
}

// Display Device Group
model DisplayDeviceGroup {
  id             String    @id @default(uuid())
  name           String
  description    String?
  devices        DisplayDevice[]
  playlists      DisplayPlaylist[]
  urgentMessages DisplayUrgentMessage[]
  createdAt      DateTime  @default(now()) @map("created_at")
  
  @@map("display_device_groups")
}

// Display Content (images, videos, text for bottom-half display)
model DisplayContent {
  id          String    @id @default(uuid())
  type        String    // 'image', 'video', 'text'
  title       String
  body        String?
  url         String?
  posterUrl   String?   @map("poster_url")
  durationSec Int       @default(10) @map("duration_sec")
  startAt     DateTime? @map("start_at")
  endAt       DateTime? @map("end_at")
  priority    Int       @default(0)
  tags        String[]
  checksum    String?
  sizeBytes   Int?      @map("size_bytes")
  mimeType    String?   @map("mime_type")
  width       Int?
  height      Int?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  playlistItems DisplayPlaylistItem[]
  
  @@index([type])
  @@map("display_content")
}

// Display Playlist
model DisplayPlaylist {
  id            String    @id @default(uuid())
  name          String
  description   String?
  version       Int       @default(1)
  active        Boolean   @default(false)
  deviceGroupId String?   @map("device_group_id")
  deviceGroup   DisplayDeviceGroup? @relation(fields: [deviceGroupId], references: [id])
  deviceId      String?   @map("device_id")
  items         DisplayPlaylistItem[]
  devices       DisplayDevice[]
  publishedAt   DateTime? @map("published_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  @@index([deviceGroupId])
  @@index([active])
  @@map("display_playlists")
}

// Display Playlist Item
model DisplayPlaylistItem {
  id          String    @id @default(uuid())
  playlistId  String    @map("playlist_id")
  playlist    DisplayPlaylist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  contentId   String    @map("content_id")
  content     DisplayContent @relation(fields: [contentId], references: [id])
  order       Int       @default(0)
  durationSec Int?      @map("duration_sec")
  startAt     DateTime? @map("start_at")
  endAt       DateTime? @map("end_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@index([playlistId])
  @@index([contentId])
  @@map("display_playlist_items")
}

// Display Device Log
model DisplayDeviceLog {
  id        String   @id @default(uuid())
  deviceId  String   @map("device_id")
  device    DisplayDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  type      String   // 'playlist_ack', 'error', 'playback', etc.
  data      Json?
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([deviceId])
  @@index([type])
  @@index([createdAt])
  @@map("display_device_logs")
}

// Display Urgent Message
model DisplayUrgentMessage {
  id            String    @id @default(uuid())
  title         String
  body          String
  priority      Int       @default(10)
  deviceGroupId String?   @map("device_group_id")
  deviceGroup   DisplayDeviceGroup? @relation(fields: [deviceGroupId], references: [id])
  deviceId      String?   @map("device_id")
  device        DisplayDevice? @relation(fields: [deviceId], references: [id])
  expiresAt     DateTime  @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@index([deviceGroupId])
  @@index([deviceId])
  @@index([expiresAt])
  @@map("display_urgent_messages")
}
