generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String  @id @default(uuid())
  email             String? @unique
  username          String? @unique
  passwordHash      String? @map("password_hash")
  displayName       String  @map("display_name")
  phoneNumber       String? @map("phone_number")
  paymentMethod     String? @map("payment_method")
  profilePictureUrl String? @map("profile_picture_url") @db.Text

  // Email verification
  emailVerified      Boolean   @default(false) @map("email_verified")
  emailVerifyToken   String?   @map("email_verify_token")
  emailVerifyExpires DateTime? @map("email_verify_expires")

  // Password reset
  passwordResetToken   String?   @map("password_reset_token")
  passwordResetExpires DateTime? @map("password_reset_expires")

  // Account security
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockUntil           DateTime? @map("lock_until")
  lastLoginAt         DateTime? @map("last_login_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  palmTemplates      PalmTemplate[]
  enrollments        Enrollment[]
  devices            Device[]
  apiTokens          ApiToken[]
  authenticationLogs AuthenticationLog[]
  cards              Card[]
  orders             Order[]
  redemptions        Redemption[]
  refreshTokens      RefreshToken[]

  @@map("users")
}

// Refresh tokens for JWT rotation
model RefreshToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tokenHash  String    @unique @map("token_hash")
  deviceInfo String?   @map("device_info")
  ipAddress  String?   @map("ip_address")
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  revokedAt  DateTime? @map("revoked_at")
  replacedBy String?   @map("replaced_by")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model PalmTemplate {
  id             String @id @default(uuid())
  userId         String @map("user_id")
  sdkVendor      String @default("veinshine") @map("sdk_vendor")
  featureVersion String @default("1.0") @map("feature_version")

  leftRgbFeature  String? @map("left_rgb_feature") @db.Text
  leftIrFeature   String? @map("left_ir_feature") @db.Text
  rightRgbFeature String? @map("right_rgb_feature") @db.Text
  rightIrFeature  String? @map("right_ir_feature") @db.Text

  active     Boolean  @default(true)
  enrolledAt DateTime @default(now()) @map("enrolled_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("palm_templates")
}

model Device {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  name       String
  platform   String
  publicKey  String?  @map("public_key") @db.Text
  lastSeenAt DateTime @default(now()) @map("last_seen_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]

  @@index([userId])
  @@map("devices")
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  deviceId  String   @map("device_id")
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceId])
  @@map("enrollments")
}

model ApiToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  scope     String   @default("palm:verify")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("api_tokens")
}

model AuthenticationLog {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  deviceType      String   @map("device_type")
  location        String?
  success         Boolean  @default(true)
  authenticatedAt DateTime @default(now()) @map("authenticated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([authenticatedAt])
  @@map("authentication_logs")
}

model Card {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  type       String
  name       String
  cardNumber String    @map("card_number")
  color      String    @default("#0066CC")
  expiryDate DateTime? @map("expiry_date")
  active     Boolean   @default(true)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  redemptions Redemption[]

  @@index([userId])
  @@map("cards")
}

// NEW MODELS FOR STORE SYSTEM

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  imageUrl    String?  @map("image_url") @db.Text
  stock       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  orderItems OrderItem[]

  @@map("products")
}

model Order {
  id           String    @id @default(uuid())
  customerId   String?   @map("customer_id")
  customerName String?   @map("customer_name")
  status       String    @default("pending") // pending, completed, cancelled
  totalAmount  Decimal   @map("total_amount") @db.Decimal(10, 2)
  palmDeviceId String?   @map("palm_device_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  completedAt  DateTime? @map("completed_at")

  customer   User?       @relation(fields: [customerId], references: [id], onDelete: SetNull)
  palmDevice PalmDevice? @relation(fields: [palmDeviceId], references: [id], onDelete: SetNull)
  items      OrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([palmDeviceId])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int     @default(1)
  price     Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Campaign Redemptions - tracks when users redeem campaign cards via palm scan
model Redemption {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  userName       String?  @map("user_name")
  cardId         String?  @map("card_id")
  campaignName   String   @map("campaign_name")
  campaignVendor String   @map("campaign_vendor")
  palmDeviceId   String?  @map("palm_device_id")
  location       String?
  status         String   @default("verified") // verified, failed
  redeemedAt     DateTime @default(now()) @map("redeemed_at")

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  card       Card?       @relation(fields: [cardId], references: [id], onDelete: SetNull)
  palmDevice PalmDevice? @relation(fields: [palmDeviceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([cardId])
  @@index([palmDeviceId])
  @@index([redeemedAt])
  @@map("redemptions")
}

model PalmDevice {
  id         String   @id @default(uuid())
  name       String
  apiToken   String   @unique @map("api_token")
  location   String?
  active     Boolean  @default(true)
  lastSeenAt DateTime @default(now()) @map("last_seen_at")
  createdAt  DateTime @default(now()) @map("created_at")

  orders         Order[]
  redemptions    Redemption[]
  deviceAuthLogs DeviceAuthenticationLog[]

  @@map("palm_devices")
}

model DeviceAuthenticationLog {
  id           String   @id @default(uuid())
  palmDeviceId String   @map("palm_device_id")
  deviceType   String   @map("device_type")
  location     String?
  success      Boolean  @default(false)
  reason       String?
  timestamp    DateTime @default(now())

  palmDevice PalmDevice @relation(fields: [palmDeviceId], references: [id], onDelete: Cascade)

  @@index([palmDeviceId])
  @@index([timestamp])
  @@map("device_authentication_logs")
}
